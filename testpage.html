<!DOCTYPE html>
<html>
<head>
	<title>Test Page</title>
	<link rel="manifest" href="/manifest.json" />
	<script src="https://cdn.onesignal.com/sdks/OneSignalSDK.js" async=""></script>
	<script>
  	var OneSignal = window.OneSignal || [];
  	OneSignal.push(function() {
    	OneSignal.init({
      	appId: "3beb3078-e0f1-4629-af17-fde833b9f716",
    	});
    	OneSignal.showSlidedownPrompt();
  	});
	</script>
</head>
<body>
  <!-- Tag upon notification click -->
  <script>
    OneSignal.push(["addListenerForNotificationOpened", function(payload) {
      console.log("Received Payload Data: ", payload.data);
      let topic = payload.data.topic;
      console.log("topic: ", topic);
      if (topic) {
        OneSignal.getTags().then(function(tags) {
          console.log("tags: ", JSON.stringify(tags));
          var tagsObj = tags;
          console.log("tagsObj: ", tagsObj);
          var topicCount = tagsObj.topic;
          console.log("topicCount: ", topicCount);
          if (topicCount && !isNaN(topicCount)) {
            topicCount += 1;
          } else {
            topicCount = 1;
          }
          OneSignal.sendTag(topic, topicCount).then(function(tagsSent) {
            console.log("tagsSent: ", JSON.stringify(tagsSent));
          });
        });
      }
    }]);
  </script>
  <!-- END Tag upon notification click -->
  <!-- Tag upon 3rd visit
  <script data-cfasync="false">
  window.OneSignal = window.OneSignal || [];
  var numVisitsTrigger = 3; /* Number of page visits before tagging user */
  var topic = "sports"; /* The topic of the page */
  /* Why use .push? See: http://stackoverflow.com/a/38466780/555547 */
  window.OneSignal.push(function() {
    var topicVisits = new Number(localStorage.getItem(topic) || 0);
    if (topicVisits !== NaN) {
      topicVisits += 1;
    } else {
      topicVisits = 0;
    }    
    localStorage.setItem(topic, topicVisits)

    if (topicVisits >= numVisitsTrigger) {
      tagUserWithPageTopic(topic, topicVisits);
    }
  });

  function tagUserWithPageTopic(key, value) {
    window.OneSignal.isPushNotificationsEnabled(function(isEnabled) {
      console.log("isEnabled: ", isEnabled);
      if (isEnabled) {        
        window.OneSignal.sendTag(key, value).then(function(tagsSent) {
        // Callback called when tags have finished sending
        console.log('tagsSent: ', tagsSent);
        });  
      }
    });
  }
  </script>
  END TAG 3rd visit -->
  <!-- Send push upon subscribe
	<script>
			OneSignal.push(function() {
  			// Occurs when the user's subscription changes to a new value.
  			OneSignal.on('subscriptionChange', function (isSubscribed) {
    			console.log("The user's subscription state is now:", isSubscribed);
          OneSignal.getUserId(function(id) {
            console.log(id);
            if (isSubscribed === true) {
              var xhttp = new XMLHttpRequest();
              xhttp.open("POST", "https://onesignal.com/api/v1/notifications", true);
              xhttp.setRequestHeader("Content-type", "application/json");
              xhttp.setRequestHeader("Access-Control-Allow-Origin","*");
              xhttp.send({
                "app_id":"3beb3078-e0f1-4629-af17-fde833b9f716",
                "contents": {"en": "New Subscriber"},
                "include_player_ids":[id]
              });
            }
          })
  			});
			});
	</script>
  -->
</body>
</html>